## Жизненный цикл классового компонента

Реакт выполняет работу `work` в две фазы:

- Render/reconciliation (сверка)
- Commit

Это внутренний процесс, через который проходит реакция для обновление страницы.

React обходит дерево компонентов и вызывает методы `render` у всех компонентов, и сравнивает полученный результат с новым. В этот промежуток он делает:

- Обновляет `state` и `props`
- Обновляет `ref`
- Вызывает методы жизненного цикла
- Сравнивает полученный результат с предыдущим
- Определяет необходимые изменения в `DOM`

Все эти операции называются работой (`work`), внутри `Fiber` ноды. Тип работы зависит от React елемента (FunctionalComponent, FunctionalComponentLazy, ClassComponent, ClassComponentLazy, Profiler ....) [ReactWorkTags](url: https://github.com/facebook/react/blob/340bfd9393e8173adca5380e6587e1ea1a23cefa/packages/shared/ReactWorkTags.js#L29-L28)
React синхронно обходит дерево, но это может быть долго, поэтому он может прерывать `render` фазу и возобновлять, тогда, когда это нужно.

### Render phase

Фаза может быть фсинхронной и React как угодно ей управляет, может остановить, продолжить или прервать. Это стало возможно, потому что на этом этапе нет видимых пользователю изменений. При первом рендеринге - React применяет обновления к компонентам, запланированным через `setState` или `React.render` и выясняет, что необходимо обновить. Если это первый рендер React создает новую `Fiber` ноду, а при последующих обновлениях уже работает с ней. Результат этой фазы является дерево `Fiber` нод, отмеченное `побочными еффектами`.

Эффекты - описывают работу (видимые юзеру изменения), которую необходимо выполнить на этапе фиксации (`commit`). Алгоритм сверки начинает работу всегда от `HostRoot`, а выполняет его
[renderRoot](url: https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L1132). Но React не обновляет все ноды при каждом обновлении, он пропускает их, быстро перемещаясь к помеченным узлам.

      Смысл данной фазы в том, что бы узнать, какие узлы нужно вставить, обновить или удалить, а каким компонентам вызвать методы жц.
      Это возможно, потому что React создает `Effect List`, в каждой ноде есть указатель `nextEffect`

React выполняет работу, плока есть ребенок или соседняя ветка, если их нет, он выходит из цикла и готов комитить изменения.
Вызов методов жц - является одним из видов работ, которые выполняет React. Некоторые методы вызываются во время `render`, другие во время `commit` фазы. Методы, помеченный как устаревшие - это методы, которые в будущем будут опасны при использовании асинхронного рендера.
`До мутационные` методы жц:

- `constructor(props)`

* `componentWillMount` (deprecated)
  Этот методы вызывается всегда, единственный метод, вызываемый при ssr. Дополнительный вызов `setState` не вызовет повтоного обновления.

* `componentWillReceiveProps(nextProps)` (deprecated)
  Метод вызывался до того, как компонент получит новые пропсы, при обновлении компонента.

* `getDerivedStateFromProps(nextProps, prevState)`

- `shouldComponentUpdate(nextProps, nextState, nextContext)`

- `componentWillUpdate` (deprecated)

- `render(props)`

### Commit phase

Этот этап всегда синхронен (потому что DOM нужно обновить за один подход, без миганий). На этом этапе React берет помеченное еффектами дерево `Effect List` (результат выполнения `render` фазы) и начинает выполнять работу каждой ноде. Идет сверху вниз, вызывая методы по порядку, но `componentDidMount`, `componentDidUpdate` - вызывает снизу вверх.

Комит фаза - всегда начинается с [completeRoot]((url: https://github.com/facebook/react/blob/95a313ec0b957f71798a69d8e83408f40e76765b/packages/react-reconciler/src/ReactFiberScheduler.js#L2306)) - React обновляет DOM и вызывает методы жц. Когда React достиг этой фазы, у него есть два дерева:

- currentWork - дерево на екране в данный момент.
- workInProgress - представляет состояние, которое должно быть на екране.

Деревья связаны через ссылку alternate. После рендера, реакт берет информацию из дерева и использует его в фазе комита

- Вызывает getSnapshotBeforeUpdate на узлах с еффектом `Snapshot` вызывает при обновлении
- Вызывает componentWillUnmount на узлах с еффектом `Deletion` вызывает при удалении
- Выполняет все обновления, связанные с DOM
- Вызывает componentDidMount на узлах с еффектом `Placement` вызывает при монтировании
- Вызывает componentDidUpdate на узлах с еффектом `Update` вызывает при апдейтах

После вызова `getSnapshotBeforeUpdate`, React комитит побочные еффекты в дереве ха два прохода. Первый - выполняет все обновления DOM дерева, затем присваивает дерево `finishedWork` => "FiberRoot", отмечая его как `current` деерво. Это делается после первого прохода `commit` фазы, что бы предыдущее дерево все еще было текущим, во время выполнения `componentWillUnmount`.
Во втором проходе React вызывает оставшиеся методы жц и коллбеки. Эти методы выполняются отдельно и все обновления уже завершины.

Постмутационные и домутационные методы жц:

- commitBeforeMutationLifecycles - вызывает метод getSnapshotBeforeUpdatelifecycle, если такой имеется.
- commitAllHostEffects - выполняет изменения в DOM, определяет тип операции для ноды и выолняет ее (удаление, обновление, добавление) в DOM.
- root.current = finishedWork;

После мутации:

- commitAllLifeCycles - вызывает оставшиеся методы жц (didUpdate, didMount)

## Жизненный цикл компонента

Монтирование

- constructor(props)
  Вызывается при монтировании

- static getDerivedStateFromProps(nextProps, prevState) (render)
  Метод вызывается всегда все, что вернет этот метод - попадет в `state`

- render(props) (render)
  Обязательный метод в классе, при вызове вернет `React Element` / массив / фрагмент/ строки / числа / портал / Boolaen / null
  Эта функция должна быть чистой, это значит, что она не должна изменять состояние компонента.

- componentDidMount() (commit)
  Не вызывается при обновлениях позволяет работать с DOM при монтировании компонента, потому что `commit` фаза.

Обновление

- static getDerivedStateFromProps(nextProps, prevState) (render)

- shouldComponentUpdate(nectProps, nextState, nextContext) (render)
  Вызывается при обновлении. Указывает необходимо ли делать следуюзий рендер на основе изменения состояния
  и пропсовю. Можно сравнить предыдущее состояние и новое, и на основе этого отменить повторное обновление.
  Если вернет `false`, то `componentDidUpdate` не будет вызван.

- render(props) (render)

- getSnapshotBeforeUpdate(prevProsp, prevState) (commit)
  Позволяет компоненту брать информацию из DOM, все, что вернет метод, попадет в `componentDidUpdate`

- componentDidUpdate(prevProps, prevState, snapshot) (commit)
  Не вызывается при первом рендере, позволяет работать с DOM при обновлении компонента, потому что `commit` фаза.
